# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Yak Saver is a Go web application for managing projects and hierarchical tasks. It uses Echo framework for HTTP routing, SQLite for data persistence, sqlc for type-safe SQL queries, and goose for database migrations.

## Development Commands

### Database Management
- `make migrate` - Run database migrations using goose
- `make seed` - Seed the database with initial data
- `make generate` - Generate Go code from SQL queries using sqlc

### Running the Application
- `air` - Run the application with hot reload (builds to `./tmp/main`, listens on port 8080)
- `go build -o ./tmp/main ./cmd` - Build the application manually
- `./tmp/main` - Run the built binary

The application serves on `http://localhost:8080` with CORS enabled for `http://localhost:5173`.

### Database Location
SQLite database is located at `data/yak-saver.db`.

## Architecture

### Layered Structure

The application follows a three-layer architecture:

1. **Handler Layer** (`internal/handler/`) - HTTP request/response handling
   - Binds request data, validates input, calls services, formats responses
   - Uses Echo framework for routing and middleware

2. **Service Layer** (`internal/service/`) - Business logic
   - `ProjectService.GetProjects()` builds hierarchical task trees from flat database results
   - `TaskService.DeleteTask()` recursively deletes all descendant tasks before deleting the parent
   - Services orchestrate multiple database queries and implement domain logic

3. **Database Layer** (`internal/database/`) - Auto-generated by sqlc
   - Type-safe query methods generated from `sql/queries/*.sql`
   - Models generated from schema in `sql/schema/*.sql`
   - Never edit generated files directly

### Key Data Model Patterns

**Hierarchical Tasks**: Tasks support unlimited nesting via self-referential `parent_task_id` foreign key. The database handles cascading deletes, but `TaskService.DeleteTask()` explicitly implements recursive deletion in application code to ensure proper cleanup.

**Task Tree Building**: `ProjectService.GetProjects()` fetches all projects and tasks in a single query pass, then builds the hierarchical structure in memory. Tasks are ordered so parent tasks appear before children, enabling single-pass tree construction.

**Project-Task Relationship**: Each task belongs to exactly one project. Deleting a project cascades to delete all associated tasks (both at database and application level).

### Database Workflow

1. Create migration: Add new `.sql` file in `sql/schema/` using goose format
2. Define queries: Add SQL queries in `sql/queries/` with sqlc annotations
3. Run `make migrate` to apply schema changes to database
4. Run `make generate` to regenerate Go code from queries
5. Generated types and methods appear in `internal/database/`

## API Endpoints

- `GET /projects` - Returns all projects with nested task hierarchies
- `POST /projects` - Create a new project (requires `name` in JSON body)
- `DELETE /projects/:id` - Delete project and all associated tasks
- `PATCH /tasks/:id` - Partially update task (JSON body with optional `content`, `link`, `completed` fields)
- `POST /tasks` - Create a new task (supports `project_id`, `parent_task_id`, `content`, `link`)
- `DELETE /tasks/:id` - Delete task and all descendant tasks recursively

## Important Notes

- All task operations that involve parent-child relationships must account for the hierarchical structure
- When adding new SQL queries, follow the existing naming pattern (`-- name: QueryName :returnType`)
- The application uses `sql.NullString` and `sql.NullInt64` for nullable database fields
- CORS is configured to allow requests from the frontend on port 5173
